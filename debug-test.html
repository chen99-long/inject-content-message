<!DOCTYPE html>
<html>
<head>
    <title>è°ƒè¯• window vs document äº‹ä»¶ä¼ é€’</title>
    <script src="./dist/index.umd.js"></script>
</head>
<body>
    <h1>è°ƒè¯•äº‹ä»¶ä¼ é€’æœºåˆ¶</h1>
    <div id="output"></div>
    <button id="testWindow">æµ‹è¯• window äº‹ä»¶</button>
    <button id="testDocument">æµ‹è¯• document äº‹ä»¶</button>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            const div = document.createElement('div');
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            output.appendChild(div);
            console.log(message);
        }
        
        // æ¨¡æ‹Ÿä¸¤ä¸ªä¸åŒçš„æ‰§è¡Œç¯å¢ƒ
        function createIsolatedContext() {
            // åˆ›å»ºä¸€ä¸ª iframe æ¥æ¨¡æ‹Ÿä¸åŒçš„ window ç¯å¢ƒ
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            const iframeWindow = iframe.contentWindow;
            const iframeDocument = iframe.contentDocument;
            
            return { window: iframeWindow, document: iframeDocument };
        }
        
        // æµ‹è¯• window äº‹ä»¶ä¼ é€’
        function testWindowEvents() {
            log('<br>ğŸ§ª æµ‹è¯• window äº‹ä»¶ä¼ é€’...');
            
            const context = createIsolatedContext();
            
            // åœ¨ä¸» window ç›‘å¬
            window.addEventListener('test-window-event', (e) => {
                log('âœ… ä¸» window æ”¶åˆ°äº‹ä»¶: ' + e.detail);
            });
            
            // åœ¨ iframe window ç›‘å¬
            context.window.addEventListener('test-window-event', (e) => {
                log('âœ… iframe window æ”¶åˆ°äº‹ä»¶: ' + e.detail);
            });
            
            // ä»ä¸» window å‘é€
            log('ğŸ“¤ ä»ä¸» window å‘é€äº‹ä»¶...');
            window.dispatchEvent(new CustomEvent('test-window-event', { detail: 'æ¥è‡ªä¸»window' }));
            
            // ä» iframe window å‘é€
            setTimeout(() => {
                log('ğŸ“¤ ä» iframe window å‘é€äº‹ä»¶...');
                context.window.dispatchEvent(new CustomEvent('test-window-event', { detail: 'æ¥è‡ªiframe window' }));
            }, 100);
        }
        
        // æµ‹è¯• document äº‹ä»¶ä¼ é€’
        function testDocumentEvents() {
            log('<br>ğŸ§ª æµ‹è¯• document äº‹ä»¶ä¼ é€’...');
            
            const context = createIsolatedContext();
            
            // åœ¨ä¸» document ç›‘å¬
            document.addEventListener('test-document-event', (e) => {
                log('âœ… ä¸» document æ”¶åˆ°äº‹ä»¶: ' + e.detail);
            });
            
            // åœ¨ iframe document ç›‘å¬
            context.document.addEventListener('test-document-event', (e) => {
                log('âœ… iframe document æ”¶åˆ°äº‹ä»¶: ' + e.detail);
            });
            
            // ä»ä¸» document å‘é€
            log('ğŸ“¤ ä»ä¸» document å‘é€äº‹ä»¶...');
            document.dispatchEvent(new CustomEvent('test-document-event', { detail: 'æ¥è‡ªä¸»document' }));
            
            // ä» iframe document å‘é€
            setTimeout(() => {
                log('ğŸ“¤ ä» iframe document å‘é€äº‹ä»¶...');
                context.document.dispatchEvent(new CustomEvent('test-document-event', { detail: 'æ¥è‡ªiframe document' }));
            }, 100);
        }
        
        // æµ‹è¯•çœŸå®çš„åº“è¡Œä¸º
        function testLibraryBehavior() {
            log('<br>ğŸ§ª æµ‹è¯•åº“çš„å®é™…è¡Œä¸º...');
            
            // ç¯å¢ƒ1ï¼šä½¿ç”¨ window
            const { defineEventMessaging: defineWithWindow } = InjectContentMessage;
            
            // ä¿®æ”¹åº“ä¸´æ—¶ä½¿ç”¨ windowï¼ˆç”¨äºå¯¹æ¯”ï¼‰
            const originalLib = defineWithWindow();
            
            // ç¯å¢ƒ1ç›‘å¬
            originalLib.listenEvent('testMessage', (data) => {
                log('ğŸ“¨ ç¯å¢ƒ1æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(data));
                return 'ç¯å¢ƒ1çš„å›å¤';
            });
            
            // ç¯å¢ƒ1å‘é€
            setTimeout(async () => {
                log('ğŸ“¤ ç¯å¢ƒ1å‘é€æ¶ˆæ¯...');
                const result = await originalLib.sendEvent('testMessage', 'Hello from ç¯å¢ƒ1');
                log('ğŸ”„ ç¯å¢ƒ1æ”¶åˆ°å›è°ƒ: ' + result);
            }, 200);
        }
        
        // ç»‘å®šæŒ‰é’®
        document.getElementById('testWindow').addEventListener('click', testWindowEvents);
        document.getElementById('testDocument').addEventListener('click', testDocumentEvents);
        
        // è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        setTimeout(() => {
            testWindowEvents();
            setTimeout(testDocumentEvents, 1000);
            setTimeout(testLibraryBehavior, 2000);
        }, 500);
    </script>
</body>
</html>
