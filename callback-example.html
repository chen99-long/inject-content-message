<!DOCTYPE html>
<html>
<head>
    <title>å›è°ƒç¤ºä¾‹</title>
    <script src="./dist/index.umd.js"></script>
</head>
<body>
    <h1>äº‹ä»¶å›è°ƒç¤ºä¾‹</h1>
    <div id="output"></div>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            const div = document.createElement('div');
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            output.appendChild(div);
            console.log(message);
        }
        
        async function runExample() {
            try {
                const { defineEventMessaging } = InjectContentMessage;
                const { sendEvent, sendEventWithCallback, listenEvent } = defineEventMessaging();
                
                log('ğŸ¯ è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
                
                // ç›‘å¬å™¨ï¼šå¤„ç†æ¶ˆæ¯å¹¶è¿”å›å“åº”
                listenEvent("injectMessage", async (message) => {
                    log(`ğŸ“¨ ç›‘å¬å™¨æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`);
                    
                    // æ¨¡æ‹Ÿä¸€äº›å¼‚æ­¥å¤„ç†
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    return `Hello from inject script! æ”¶åˆ°äº†: ${JSON.stringify(message)}`;
                });
                
                log('âœ… ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
                
                // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿ç›‘å¬å™¨å·²è®¾ç½®
                await new Promise(resolve => setTimeout(resolve, 200));
                
                log('<br>ğŸ“¤ <strong>æ–¹æ³•1: ä½¿ç”¨ sendEventWithCallbackï¼ˆæ¨èï¼‰</strong>');
                log('å‘é€å­—ç¬¦ä¸²æ•°æ®...');
                
                const result1 = await sendEventWithCallback("injectMessage", "Hello from content script");
                log(`âœ… æ”¶åˆ°å›è°ƒ: <span style="color: green;">${result1}</span>`);
                
                log('<br>ğŸ“¤ <strong>æ–¹æ³•2: ä½¿ç”¨ sendEventWithCallback å‘é€å¤æ‚æ•°æ®</strong>');
                
                const result2 = await sendEventWithCallback("injectMessage", {
                    type: "request",
                    data: { id: 123, name: "test" },
                    timestamp: Date.now()
                });
                log(`âœ… æ”¶åˆ°å›è°ƒ: <span style="color: green;">${result2}</span>`);
                
                log('<br>ğŸ“¤ <strong>æ–¹æ³•3: ä½¿ç”¨åŸæ¥çš„ sendEventï¼ˆéœ€è¦å¯¹è±¡æ ¼å¼ï¼‰</strong>');
                
                const result3 = await sendEvent("injectMessage", { 
                    message: "Hello from content script via sendEvent" 
                });
                log(`âœ… æ”¶åˆ°å›è°ƒ: <span style="color: green;">${result3}</span>`);
                
                log('<br>ğŸ“¤ <strong>æ–¹æ³•4: å‘é€å­—ç¬¦ä¸²ç»™ sendEventï¼ˆä¸ä¼šæœ‰å›è°ƒï¼‰</strong>');
                
                const result4 = await sendEvent("injectMessage", "This won't get a callback");
                log(`âš ï¸ sendEvent å­—ç¬¦ä¸²ç»“æœ: <span style="color: orange;">${result4}</span> (undefinedï¼Œå› ä¸ºä¸æ˜¯å¯¹è±¡)`);
                
                log('<br>ğŸ‰ <strong>æ‰€æœ‰æµ‹è¯•å®Œæˆï¼</strong>');
                
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
                console.error(error);
            }
        }
        
        // è¿è¡Œç¤ºä¾‹
        runExample();
    </script>
</body>
</html>
