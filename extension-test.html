<!DOCTYPE html>
<html>
<head>
    <title>æ¨¡æ‹Ÿæ’ä»¶ç¯å¢ƒæµ‹è¯•</title>
    <script src="./dist/index.umd.js"></script>
</head>
<body>
    <h1>æ¨¡æ‹Ÿ Content Script å’Œ Inject Script é€šä¿¡</h1>
    <div id="output"></div>
    <button id="testBtn">æµ‹è¯•é€šä¿¡</button>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message, source = '') {
            const div = document.createElement('div');
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}] ${source}</strong> ${message}`;
            output.appendChild(div);
            console.log(`${source}: ${message}`);
        }
        
        // æ¨¡æ‹Ÿ Inject Script ç¯å¢ƒ
        function setupInjectScript() {
            log('è®¾ç½® Inject Script ç›‘å¬å™¨...', 'INJECT');
            
            const { defineEventMessaging } = InjectContentMessage;
            const { sendEvent, listenEvent } = defineEventMessaging();
            
            // ç›‘å¬æ¥è‡ª content script çš„æ¶ˆæ¯
            listenEvent("fromContent", async (message) => {
                log(`æ”¶åˆ°æ¥è‡ª Content Script çš„æ¶ˆæ¯: ${JSON.stringify(message)}`, 'INJECT');
                
                // æ¨¡æ‹Ÿä¸€äº›å¤„ç†
                await new Promise(resolve => setTimeout(resolve, 100));
                
                return `Inject Script å›å¤: å·²å¤„ç† ${JSON.stringify(message)}`;
            });
            
            // ç›‘å¬æ¥è‡ª content script çš„å¦ä¸€ç§æ¶ˆæ¯
            listenEvent("getData", async (data) => {
                log(`æ”¶åˆ°æ•°æ®è¯·æ±‚: ${JSON.stringify(data)}`, 'INJECT');
                return { 
                    id: data.id, 
                    value: `æ¥è‡ª inject script çš„æ•°æ® ${data.id}`,
                    timestamp: Date.now()
                };
            });
            
            log('âœ… Inject Script ç›‘å¬å™¨è®¾ç½®å®Œæˆ', 'INJECT');
            
            return { sendEvent, listenEvent };
        }
        
        // æ¨¡æ‹Ÿ Content Script ç¯å¢ƒ
        function setupContentScript() {
            log('è®¾ç½® Content Script...', 'CONTENT');
            
            const { defineEventMessaging } = InjectContentMessage;
            const { sendEvent, listenEvent } = defineEventMessaging();
            
            log('âœ… Content Script è®¾ç½®å®Œæˆ', 'CONTENT');
            
            return { sendEvent, listenEvent };
        }
        
        // åˆå§‹åŒ–
        const injectScript = setupInjectScript();
        const contentScript = setupContentScript();
        
        // æµ‹è¯•å‡½æ•°
        async function testCommunication() {
            try {
                log('<br>ğŸš€ å¼€å§‹æµ‹è¯•é€šä¿¡...', 'TEST');
                
                // æµ‹è¯•1: Content Script å‘é€å­—ç¬¦ä¸²æ¶ˆæ¯ç»™ Inject Script
                log('æµ‹è¯•1: å‘é€å­—ç¬¦ä¸²æ¶ˆæ¯', 'CONTENT');
                const result1 = await contentScript.sendEvent("fromContent", "Hello from Content Script!");
                log(`âœ… æ”¶åˆ°å›è°ƒ: ${result1}`, 'CONTENT');
                
                // æµ‹è¯•2: Content Script è¯·æ±‚æ•°æ®
                log('<br>æµ‹è¯•2: è¯·æ±‚æ•°æ®', 'CONTENT');
                const result2 = await contentScript.sendEvent("getData", { id: 123 });
                log(`âœ… æ”¶åˆ°æ•°æ®: ${JSON.stringify(result2)}`, 'CONTENT');
                
                // æµ‹è¯•3: å‘é€å¤æ‚å¯¹è±¡
                log('<br>æµ‹è¯•3: å‘é€å¤æ‚å¯¹è±¡', 'CONTENT');
                const result3 = await contentScript.sendEvent("fromContent", {
                    type: "complex",
                    data: { name: "test", values: [1, 2, 3] },
                    timestamp: Date.now()
                });
                log(`âœ… æ”¶åˆ°å›è°ƒ: ${result3}`, 'CONTENT');
                
                log('<br>ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'TEST');
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'ERROR');
                console.error(error);
            }
        }
        
        // ç»‘å®šæµ‹è¯•æŒ‰é’®
        document.getElementById('testBtn').addEventListener('click', testCommunication);
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œä¸€æ¬¡æµ‹è¯•
        setTimeout(testCommunication, 1000);
    </script>
</body>
</html>
