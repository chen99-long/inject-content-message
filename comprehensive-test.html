<!DOCTYPE html>
<html>
<head>
    <title>å…¨é¢æµ‹è¯•</title>
    <script src="./dist/index.umd.js"></script>
</head>
<body>
    <h1>å…¨é¢æµ‹è¯•äº‹ä»¶æ¶ˆæ¯ä¼ é€’</h1>
    <div id="output"></div>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) {
                div.style.color = 'red';
            }
            output.appendChild(div);
            console.log(message);
        }
        
        async function runTests() {
            try {
                const { defineEventMessaging } = InjectContentMessage;
                const { sendEvent, listenEvent } = defineEventMessaging();
                
                log('âœ… åˆå§‹åŒ–æˆåŠŸ');
                
                // æµ‹è¯•è®¡æ•°å™¨
                let testCount = 0;
                let passedCount = 0;
                
                function test(name, fn) {
                    testCount++;
                    try {
                        fn();
                        passedCount++;
                        log(`âœ… æµ‹è¯• ${testCount}: ${name} - é€šè¿‡`);
                    } catch (error) {
                        log(`âŒ æµ‹è¯• ${testCount}: ${name} - å¤±è´¥: ${error.message}`, true);
                    }
                }
                
                // è®¾ç½®ç›‘å¬å™¨
                const messages = [];
                
                listenEvent('stringEvent', (message) => {
                    messages.push({ type: 'string', data: message });
                    log(`ğŸ“¨ æ”¶åˆ°å­—ç¬¦ä¸²äº‹ä»¶: ${message}`);
                });
                
                listenEvent('numberEvent', (num) => {
                    messages.push({ type: 'number', data: num });
                    log(`ğŸ“¨ æ”¶åˆ°æ•°å­—äº‹ä»¶: ${num}`);
                });
                
                listenEvent('objectEvent', (obj) => {
                    messages.push({ type: 'object', data: obj });
                    log(`ğŸ“¨ æ”¶åˆ°å¯¹è±¡äº‹ä»¶: ${JSON.stringify(obj)}`);
                });
                
                listenEvent('callbackEvent', async (data) => {
                    log(`ğŸ“¨ æ”¶åˆ°å›è°ƒäº‹ä»¶: ${JSON.stringify(data)}`);
                    return { result: `å¤„ç†äº† ${data.value}` };
                });
                
                // ç­‰å¾…ä¸€ä¸‹è®©ç›‘å¬å™¨è®¾ç½®å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // æµ‹è¯•1: å­—ç¬¦ä¸²äº‹ä»¶ï¼ˆä¹‹å‰ä¼šæŠ¥é”™çš„æƒ…å†µï¼‰
                test('å­—ç¬¦ä¸²äº‹ä»¶', () => {
                    sendEvent('stringEvent', 'Hello World');
                });
                
                // æµ‹è¯•2: æ•°å­—äº‹ä»¶
                test('æ•°å­—äº‹ä»¶', () => {
                    sendEvent('numberEvent', 42);
                });
                
                // æµ‹è¯•3: å¸ƒå°”å€¼äº‹ä»¶
                test('å¸ƒå°”å€¼äº‹ä»¶', () => {
                    sendEvent('stringEvent', true);
                });
                
                // æµ‹è¯•4: null äº‹ä»¶
                test('null äº‹ä»¶', () => {
                    sendEvent('stringEvent', null);
                });
                
                // æµ‹è¯•5: undefined äº‹ä»¶
                test('undefined äº‹ä»¶', () => {
                    sendEvent('stringEvent', undefined);
                });
                
                // æµ‹è¯•6: æ™®é€šå¯¹è±¡äº‹ä»¶
                test('æ™®é€šå¯¹è±¡äº‹ä»¶', () => {
                    sendEvent('objectEvent', { name: 'test', value: 123 });
                });
                
                // æµ‹è¯•7: å¸¦å›è°ƒçš„äº‹ä»¶
                test('å¸¦å›è°ƒçš„äº‹ä»¶', async () => {
                    const result = await sendEvent('callbackEvent', { value: 'test data' });
                    if (result && result.result === 'å¤„ç†äº† test data') {
                        log(`âœ… å›è°ƒç»“æœæ­£ç¡®: ${JSON.stringify(result)}`);
                    } else {
                        throw new Error(`å›è°ƒç»“æœä¸æ­£ç¡®: ${JSON.stringify(result)}`);
                    }
                });
                
                // ç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 500));
                
                log(`\nğŸ“Š æµ‹è¯•æ€»ç»“: ${passedCount}/${testCount} é€šè¿‡`);

                listenEvent("injectMessage",  async (data) => {
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
                    return "Hello from injectscript";
                });

                async function testInjectMessage() {
                    log('ğŸš€ æµ‹è¯•ä¿®å¤åçš„ sendEvent æ–¹æ³•');

                    // ç°åœ¨ sendEvent æ”¯æŒä»»æ„ç±»å‹æ•°æ®çš„å›è°ƒäº†ï¼
                    const result1 = await sendEvent("injectMessage", "Hello from content script");
                    log(`âœ… å­—ç¬¦ä¸²æ•°æ®å›è°ƒç»“æœ: ${result1}`);

                    const result2 = await sendEvent("injectMessage", { message: "Hello from content script" });
                    log(`âœ… å¯¹è±¡æ•°æ®å›è°ƒç»“æœ: ${result2}`);
                }

                testInjectMessage();
        
                
                if (passedCount === testCount) {
                    log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¿®å¤æˆåŠŸï¼');
                } else {
                    log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥', true);
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, true);
                console.error(error);
            }
        }
        
        // è¿è¡Œæµ‹è¯•
        runTests();



    </script>
</body>
</html>
